# 分布式集群部署指南

## 🎯 概述

本系统现已支持分布式集群部署，通过Redis作为共享存储解决了Token黑名单同步问题，确保集群环境下的登录安全性。

## ✅ 集群支持现状

### 完全支持的组件
- ✅ **JWT认证系统**: 无状态设计，天然支持集群
- ✅ **用户管理**: 基于数据库存储，支持多节点访问
- ✅ **Token黑名单**: 支持Redis和本地内存两种存储方式
- ✅ **会话缓存**: 基于Redis实现分布式缓存
- ✅ **数据持久化**: 共享MySQL数据库

### 配置灵活性
- 🔧 **单机模式**: 使用本地内存存储，性能最优
- 🔧 **集群模式**: 使用Redis存储，支持水平扩展

## 🚀 部署模式

### 1. 单机部署（默认）
```bash
# 使用本地内存Token黑名单
TOKEN_BLACKLIST_TYPE=local
```

**特点:**
- 性能最优，无网络开销
- 适用于小规模应用
- 不支持水平扩展

### 2. 集群部署（推荐生产环境）
```bash
# 使用Redis Token黑名单
TOKEN_BLACKLIST_TYPE=redis
```

**特点:**
- 支持多节点部署
- Token黑名单实时同步
- 支持水平扩展
- 高可用性

## 📋 集群部署步骤

### 步骤1: 环境配置
```bash
# 复制环境配置文件
cp env.sample .env

# 编辑配置文件
vim .env
```

关键配置项:
```bash
# 启用Redis Token黑名单
TOKEN_BLACKLIST_TYPE=redis

# Redis连接信息
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# JWT密钥（所有节点必须相同）
APP_JWT_SECRET=YourSecretKeyAtLeast32BytesLength

# 数据库连接（所有节点共享）
DB_HOST=your-mysql-host
DB_NAME=enlighten_platform
DB_ROOT_PASSWORD=your-db-password
```

### 步骤2: 启动基础设施
```bash
# 启动MySQL和Redis
docker-compose up -d mysql redis

# 等待服务启动完成
docker-compose logs -f mysql redis
```

### 步骤3: 部署应用集群
```bash
# 节点1
docker-compose up -d app

# 节点2 (不同端口)
APP_PORT=8081 docker-compose -f docker-compose.yml up -d app

# 节点3 (不同端口)
APP_PORT=8082 docker-compose -f docker-compose.yml up -d app
```

### 步骤4: 配置负载均衡
使用Nginx或其他负载均衡器:

```nginx
upstream enlighten_cluster {
    server localhost:8080;
    server localhost:8081;
    server localhost:8082;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://enlighten_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## 🔧 配置详解

### Token黑名单配置

#### 本地内存模式 (单机)
```properties
app.token-blacklist.type=local
```
- 优点: 性能最优，无网络延迟
- 缺点: 不支持集群，存在安全隐患

#### Redis模式 (集群)
```properties
app.token-blacklist.type=redis
spring.data.redis.host=redis-host
spring.data.redis.port=6379
spring.data.redis.password=redis-password
```
- 优点: 支持集群，数据一致性
- 缺点: 轻微性能开销

### JWT配置
```properties
# JWT密钥（所有节点必须相同）
app.jwt.secret=YourSecretKeyAtLeast32BytesLength
# Token有效期（7天）
app.jwt.expire-seconds=604800
```

### Redis配置
```properties
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.database=${REDIS_DB:0}
spring.data.redis.timeout=5s
```

## 🧪 集群测试

### 1. 功能测试
```bash
# 在节点1登录
curl -X POST "http://node1:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'

# 使用返回的token在节点2访问
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer your_jwt_token"

# 在节点1退出登录
curl -X POST "http://node1:8080/api/auth/logout" \
  -H "Authorization: Bearer your_jwt_token"

# 验证token在节点2也已失效
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer your_jwt_token"
# 应返回: {"code":401,"message":"令牌已失效"}
```

### 2. 性能测试
```bash
# 使用Apache Bench测试集群性能
ab -n 1000 -c 10 -H "Authorization: Bearer valid_token" \
   http://load-balancer/api/user/list
```

### 3. 高可用测试
```bash
# 停止节点1
docker-compose stop app

# 验证节点2和节点3仍可正常服务
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer valid_token"
```

## 📊 监控与运维

### 1. 健康检查
```bash
# 检查应用健康状态
curl http://node:8080/actuator/health

# 检查Redis连接
redis-cli -h redis-host ping
```

### 2. 监控指标
- Token黑名单大小
- Redis连接状态
- 数据库连接池状态
- 应用响应时间

### 3. 日志聚合
建议使用ELK Stack或类似方案收集各节点日志:
```bash
# 查看应用日志
docker-compose logs -f app

# 查看Redis日志
docker-compose logs -f redis
```

## ⚠️ 注意事项

### 1. 安全考虑
- **JWT密钥同步**: 所有节点必须使用相同的JWT密钥
- **Redis安全**: 生产环境建议启用Redis密码认证
- **网络安全**: 使用VPC或防火墙保护内部通信

### 2. 性能优化
- **Redis连接池**: 配置合适的连接池大小
- **Token TTL**: 合理设置Token过期时间
- **缓存策略**: 根据业务需求调整缓存策略

### 3. 故障处理
- **Redis故障**: 系统会自动降级，但退出登录功能受影响
- **数据库故障**: 影响所有节点，需要快速恢复
- **节点故障**: 负载均衡器自动切换到健康节点

## 🔮 扩展建议

### 1. 进一步优化
- 使用Redis Cluster提高Redis可用性
- 实现Token刷新机制
- 添加分布式锁防止并发问题

### 2. 监控增强
- 集成Prometheus + Grafana监控
- 添加自定义业务指标
- 实现告警机制

### 3. 安全增强
- 实现IP白名单
- 添加请求频率限制
- 集成OAuth2/OIDC

## 📝 总结

通过以上改进，系统现已完全支持分布式集群部署：

✅ **安全性**: Token黑名单在集群间实时同步  
✅ **可扩展性**: 支持水平扩展，按需添加节点  
✅ **高可用性**: 单节点故障不影响整体服务  
✅ **灵活性**: 支持单机和集群两种部署模式  

您现在可以根据业务需求选择合适的部署模式，生产环境强烈推荐使用Redis模式以确保集群安全性。
