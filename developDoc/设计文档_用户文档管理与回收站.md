## 背景与目标

为满足用户对“用户文档管理（以公众号文章为核心）+ 文件夹管理 + 回收站”的使用需求，本设计在现有分层（Controller/Service/Repository/Entity）与 MyBatis-Plus、JWT 鉴权、Flyway 迁移方案上扩展，实现：
- 公众号内容插入/更新/删除/查询（含分页、排序、批量操作）
- 文件夹管理（插入、重命名、顺序调整、软删除）
- 回收站管理（分页查询、恢复、清空；限制最近30天）
- 关联策略：删除文件夹时，文件夹下文章同步软删除并入回收站；恢复文章若文件夹已删除则移动到根目录
- 自动命名：插入公众号内容时支持自动命名“MMdd-公众号-当日编号”


## 需求分析

来源文档：`developDoc/READEME_MINE_CONTENT.md`

- 公众号内容插入
  - 返回记录ID；状态=初始化；标签默认“公众号文章”；无需更新最后编辑时间
  - 当名称为空时，自动命名：MMdd-公众号-序号（示例：0919-公众号-1）
- 公众号内容更新
  - 可更新：文件夹ID、名称、标签、封面URL、原文、排版内容；状态置为“编辑中”；更新最后编辑时间
- 公众号删除
  - 软删除，记录删除时间，插入回收站
- 公众号内容查询
  - 条件：用户ID、文件夹ID、名称（模糊）、标签、状态；仅未删除；分页；排序（最后编辑时间、名称、创建时间，正/倒序）
- 文件夹管理
  - 插入、更新名称、删除、查询列表（按顺序字段排序）、支持自定义顺序
  - 新增：名称重名自动追加（1）（2）…；删除采用软删除
  - 删除时：其下文章软删除并入回收站
- 回收站管理
  - 分页查询（按删除时间倒序，仅最近30天）
  - 恢复删除的内容（移除回收站、文章软删标记复位）；若原文件夹已删除/不存在，文章恢复到根目录
  - 清空回收站；支持批量
- 批量操作
  - 批量删除文章、批量更新状态、批量移动到文件夹、批量恢复


## 接口设计（对外 API）

鉴权：统一使用 Bearer JWT；用户信息从 `UserContext` 获取。

### 文章（公众号）
- POST `/api/gzh/article/create`
  - 入参：folderId?，name?，tag?，coverImageUrl?，originalText?，typesetContent?
  - 逻辑：name 为空则自动命名；状态=INITIAL；deleted=0
  - 出参：{ id }

- POST `/api/gzh/article/update`
  - 入参：id，folderId?，name?，tag?，coverImageUrl?，originalText?，typesetContent?
  - 逻辑：状态=EDITING；更新 lastEditTime

- POST `/api/gzh/article/delete`
  - 入参：id；逻辑：软删除；写入回收站（file_type=WECHAT_ARTICLE）

- POST `/api/gzh/article/delete-batch`
  - 入参：ids[]；逻辑：批量软删除并入回收站

- POST `/api/gzh/article/status-batch`
  - 入参：{ ids[], status }

- POST `/api/gzh/article/move-batch`
  - 入参：{ ids[], folderId }

- GET `/api/gzh/article/page`
  - 入参：folderId?，name?（模糊），tag?，status?，page=1，size=10，sortBy=last_edit_time|name|create_time，asc=false
  - 仅返回未删除记录

### 文件夹
- POST `/api/folder/create`
  - 入参：name，sort?
  - 逻辑：若重名，自动追加（1）（2）… 直至唯一（同用户且未删除范围）

- POST `/api/folder/rename`
  - 入参：folderId，name；逻辑同上，重名自动追加

- POST `/api/folder/delete`
  - 入参：folderId；逻辑：软删除文件夹，目录下的文章批量软删除并入回收站

- GET `/api/folder/list`
  - 出参：按 sort、id 升序，过滤未删除

- POST `/api/folder/sort`
  - 入参：folderIdsInOrder[]；逻辑：依序写回 sort

### 回收站
- GET `/api/recycle/page`
  - 入参：page=1，size=10
  - 逻辑：仅查询最近30天，按 delete_time DESC

- POST `/api/recycle/restore`
  - 入参：recycleIds[]（回收站条目ID）
  - 逻辑：恢复文章；若原文件夹被删/不存在，则将文章移动到根目录（folderId=null）

- POST `/api/recycle/empty`
  - 入参：recycleIds[]；逻辑：删除选中回收站条目


## 库表设计

使用 Flyway 迁移，新增与变更：
- `V26__create_gzh_and_recycle_tables.sql`
  - `gzh_article`：公众号文章
    - 关键字段：user_id, folder_id, name, name_pinyin, tag, cover_image_url, original_text, typeset_content, status, last_edit_time, deleted, delete_time, create_time, update_time
    - 索引：idx_user_deleted(user_id,deleted)、idx_folder(folder_id)、idx_status(status)、idx_tag(tag)、idx_last_edit_time、idx_create_time、idx_name、idx_name_pinyin
  - `recycle_bin`：回收站
    - 字段：user_id, file_id, file_type, delete_time, create_time, update_time
    - 索引：idx_user_delete_time、idx_user_type、idx_user_file
  - `folder`：文件夹
    - 字段：id, user_id, name, sort, create_time, update_time
- `V27__alter_folder_add_soft_delete.sql`
  - `folder` 新增软删字段：deleted、delete_time
  - 调整唯一约束：`uk_user_name_not_deleted(user_id, name, deleted)`，避免与已删除同名冲突
  - 辅助索引：`idx_user_deleted_sort(user_id, deleted, sort)`

说明：`name_pinyin` 预留用于按汉语拼音首字母排序，当前未强制生成，可在后续优化中补充生成逻辑与回填任务。


## 详细设计

### 分层与主要类
- Entity：`GzhArticle`、`Folder`（@TableLogic deleted）、`RecycleBinItem`
- Repository：对应 `*Repository` + `ServiceImpl<BaseMapper, Entity>` 实现
- Service：
  - `GzhArticleServiceImpl`
    - createInitial：自动命名；默认 tag；status=INITIAL；deleted=0
    - updateEditing：可更新字段；status=EDITING；更新 lastEditTime
    - softDelete/batchSoftDelete：软删并写入回收站
    - batchUpdateStatus：批量更新状态
    - batchMoveToFolder：批量移动
    - pageQuery：条件过滤与多种排序（last_edit_time/name/name_pinyin/create_time）
  - `FolderServiceImpl`
    - create/rename：同用户未删除范围内重名追加（1）（2）…
    - deleteSoft：软删文件夹；查询其下文章并批量软删入回收站
    - listByUser：仅返回未删除，按 sort、id
    - updateOrders：批量更新 sort
  - `RecycleBinServiceImpl`
    - page：最近30天、delete_time DESC
    - restoreArticles：恢复文章；若原文件夹不存在或被删→ folderId=null（根目录）；移除回收站条目
    - empty：删除选中回收站条目

### 自动命名规则
- 当 createInitial 的 name 为空：
  - 统计当日同用户已创建数量（基于 create_time 当天范围）
  - 生成 `MMdd-公众号-{序号}`，若重名则自增序号直到唯一

### 软删除与回收站
- 文章：`deleted=1`、`delete_time=now()`，并写一条回收站记录（file_type=WECHAT_ARTICLE）
- 文件夹：`deleted=1`、`delete_time=now()`；其下未删文章批量软删并入回收站
- 恢复文章：清空 deleted 与 delete_time；若原 folder 已删除或不存在→ `folderId=null`
- 回收站查询：限制最近30天

### 排序与检索
- 文章页支持排序字段：last_edit_time、name（退化到 name_pinyin + name）、create_time；asc 控制升降序
- 名称模糊使用 `like(name)`；后续可扩展为 `like name or like name_pinyin` 以兼顾中文/拼音


## 事务与一致性
- 删除文件夹 → 文章批量软删入回收站：建议以“同一用户”为维度的短事务（当前实现为同进程顺序写入）
- 回收站恢复：两段更新（文章状态、删除回收站条目），可接受“至少一次”语义；若需强一致可引入事务包裹


## 安全与鉴权
- 所有接口均要求 JWT（`@SecurityRequirement(name = "bearer-jwt")`）
- 通过 `UserContext.get()` 获取 `userId` 并作为数据隔离条件


## 监控与日志
- 可在关键写操作（删除、恢复、移动、重命名）处打印审计日志（含 userId、资源ID、时间、操作结果）
- 失败场景返回统一 `Result` 包装与 `ErrorCode`


## 迁移与兼容
- Flyway 迁移脚本幂等：通过 information_schema 判断后按需 DDL
- 对存量数据：
  - `folder` 的 deleted 默认 0；需回填的仅在历史“删除”的语义存在时另行处理
  - `gzh_article.name_pinyin` 暂可空，后续回填


## 测试要点
- 单体：
  - 自动命名唯一性（并发场景）、重名追加逻辑
  - 文件夹软删后文章批量软删入回收站
  - 回收站恢复到根目录策略
  - 回收站仅近30天过滤正确性
  - 分页与排序（last_edit_time/name/create_time）
- 集成：
  - 鉴权态的接口联调（创建→更新→删除→回收站→恢复/清空）


## 后续优化
- 文章 `name_pinyin` 自动生成与历史回填（定时任务或保存时生成）
- 回收站支持 type 过滤/搜索
- 文件夹回收站化（记录文件夹回收条目与恢复接口）
- 回收站保留期可配置（默认30天）
- 批量操作的幂等保障（去重/乐观锁）


