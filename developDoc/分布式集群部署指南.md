# åˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²æŒ‡å—

## ğŸ¯ æ¦‚è¿°

æœ¬ç³»ç»Ÿç°å·²æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼Œé€šè¿‡Redisä½œä¸ºå…±äº«å­˜å‚¨è§£å†³äº†Tokené»‘åå•åŒæ­¥é—®é¢˜ï¼Œç¡®ä¿é›†ç¾¤ç¯å¢ƒä¸‹çš„ç™»å½•å®‰å…¨æ€§ã€‚

## âœ… é›†ç¾¤æ”¯æŒç°çŠ¶

### å®Œå…¨æ”¯æŒçš„ç»„ä»¶
- âœ… **JWTè®¤è¯ç³»ç»Ÿ**: æ— çŠ¶æ€è®¾è®¡ï¼Œå¤©ç„¶æ”¯æŒé›†ç¾¤
- âœ… **ç”¨æˆ·ç®¡ç†**: åŸºäºæ•°æ®åº“å­˜å‚¨ï¼Œæ”¯æŒå¤šèŠ‚ç‚¹è®¿é—®
- âœ… **Tokené»‘åå•**: æ”¯æŒRediså’Œæœ¬åœ°å†…å­˜ä¸¤ç§å­˜å‚¨æ–¹å¼
- âœ… **ä¼šè¯ç¼“å­˜**: åŸºäºRediså®ç°åˆ†å¸ƒå¼ç¼“å­˜
- âœ… **æ•°æ®æŒä¹…åŒ–**: å…±äº«MySQLæ•°æ®åº“

### é…ç½®çµæ´»æ€§
- ğŸ”§ **å•æœºæ¨¡å¼**: ä½¿ç”¨æœ¬åœ°å†…å­˜å­˜å‚¨ï¼Œæ€§èƒ½æœ€ä¼˜
- ğŸ”§ **é›†ç¾¤æ¨¡å¼**: ä½¿ç”¨Rediså­˜å‚¨ï¼Œæ”¯æŒæ°´å¹³æ‰©å±•

## ğŸš€ éƒ¨ç½²æ¨¡å¼

### 1. å•æœºéƒ¨ç½²ï¼ˆé»˜è®¤ï¼‰
```bash
# ä½¿ç”¨æœ¬åœ°å†…å­˜Tokené»‘åå•
TOKEN_BLACKLIST_TYPE=local
```

**ç‰¹ç‚¹:**
- æ€§èƒ½æœ€ä¼˜ï¼Œæ— ç½‘ç»œå¼€é”€
- é€‚ç”¨äºå°è§„æ¨¡åº”ç”¨
- ä¸æ”¯æŒæ°´å¹³æ‰©å±•

### 2. é›†ç¾¤éƒ¨ç½²ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
```bash
# ä½¿ç”¨Redis Tokené»‘åå•
TOKEN_BLACKLIST_TYPE=redis
```

**ç‰¹ç‚¹:**
- æ”¯æŒå¤šèŠ‚ç‚¹éƒ¨ç½²
- Tokené»‘åå•å®æ—¶åŒæ­¥
- æ”¯æŒæ°´å¹³æ‰©å±•
- é«˜å¯ç”¨æ€§

## ğŸ“‹ é›†ç¾¤éƒ¨ç½²æ­¥éª¤

### æ­¥éª¤1: ç¯å¢ƒé…ç½®
```bash
# å¤åˆ¶ç¯å¢ƒé…ç½®æ–‡ä»¶
cp env.sample .env

# ç¼–è¾‘é…ç½®æ–‡ä»¶
vim .env
```

å…³é”®é…ç½®é¡¹:
```bash
# å¯ç”¨Redis Tokené»‘åå•
TOKEN_BLACKLIST_TYPE=redis

# Redisè¿æ¥ä¿¡æ¯
REDIS_HOST=your-redis-host
REDIS_PORT=6379
REDIS_PASSWORD=your-redis-password

# JWTå¯†é’¥ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ç›¸åŒï¼‰
APP_JWT_SECRET=YourSecretKeyAtLeast32BytesLength

# æ•°æ®åº“è¿æ¥ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å…±äº«ï¼‰
DB_HOST=your-mysql-host
DB_NAME=enlighten_platform
DB_ROOT_PASSWORD=your-db-password
```

### æ­¥éª¤2: å¯åŠ¨åŸºç¡€è®¾æ–½
```bash
# å¯åŠ¨MySQLå’ŒRedis
docker-compose up -d mysql redis

# ç­‰å¾…æœåŠ¡å¯åŠ¨å®Œæˆ
docker-compose logs -f mysql redis
```

### æ­¥éª¤3: éƒ¨ç½²åº”ç”¨é›†ç¾¤
```bash
# èŠ‚ç‚¹1
docker-compose up -d app

# èŠ‚ç‚¹2 (ä¸åŒç«¯å£)
APP_PORT=8081 docker-compose -f docker-compose.yml up -d app

# èŠ‚ç‚¹3 (ä¸åŒç«¯å£)
APP_PORT=8082 docker-compose -f docker-compose.yml up -d app
```

### æ­¥éª¤4: é…ç½®è´Ÿè½½å‡è¡¡
ä½¿ç”¨Nginxæˆ–å…¶ä»–è´Ÿè½½å‡è¡¡å™¨:

```nginx
upstream enlighten_cluster {
    server localhost:8080;
    server localhost:8081;
    server localhost:8082;
}

server {
    listen 80;
    server_name your-domain.com;
    
    location / {
        proxy_pass http://enlighten_cluster;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

## ğŸ”§ é…ç½®è¯¦è§£

### Tokené»‘åå•é…ç½®

#### æœ¬åœ°å†…å­˜æ¨¡å¼ (å•æœº)
```properties
app.token-blacklist.type=local
```
- ä¼˜ç‚¹: æ€§èƒ½æœ€ä¼˜ï¼Œæ— ç½‘ç»œå»¶è¿Ÿ
- ç¼ºç‚¹: ä¸æ”¯æŒé›†ç¾¤ï¼Œå­˜åœ¨å®‰å…¨éšæ‚£

#### Redisæ¨¡å¼ (é›†ç¾¤)
```properties
app.token-blacklist.type=redis
spring.data.redis.host=redis-host
spring.data.redis.port=6379
spring.data.redis.password=redis-password
```
- ä¼˜ç‚¹: æ”¯æŒé›†ç¾¤ï¼Œæ•°æ®ä¸€è‡´æ€§
- ç¼ºç‚¹: è½»å¾®æ€§èƒ½å¼€é”€

### JWTé…ç½®
```properties
# JWTå¯†é’¥ï¼ˆæ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ç›¸åŒï¼‰
app.jwt.secret=YourSecretKeyAtLeast32BytesLength
# Tokenæœ‰æ•ˆæœŸï¼ˆ7å¤©ï¼‰
app.jwt.expire-seconds=604800
```

### Redisé…ç½®
```properties
spring.data.redis.host=${REDIS_HOST:localhost}
spring.data.redis.port=${REDIS_PORT:6379}
spring.data.redis.password=${REDIS_PASSWORD:}
spring.data.redis.database=${REDIS_DB:0}
spring.data.redis.timeout=5s
```

## ğŸ§ª é›†ç¾¤æµ‹è¯•

### 1. åŠŸèƒ½æµ‹è¯•
```bash
# åœ¨èŠ‚ç‚¹1ç™»å½•
curl -X POST "http://node1:8080/api/auth/login" \
  -H "Content-Type: application/json" \
  -d '{"username":"admin","password":"123456"}'

# ä½¿ç”¨è¿”å›çš„tokenåœ¨èŠ‚ç‚¹2è®¿é—®
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer your_jwt_token"

# åœ¨èŠ‚ç‚¹1é€€å‡ºç™»å½•
curl -X POST "http://node1:8080/api/auth/logout" \
  -H "Authorization: Bearer your_jwt_token"

# éªŒè¯tokenåœ¨èŠ‚ç‚¹2ä¹Ÿå·²å¤±æ•ˆ
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer your_jwt_token"
# åº”è¿”å›: {"code":401,"message":"ä»¤ç‰Œå·²å¤±æ•ˆ"}
```

### 2. æ€§èƒ½æµ‹è¯•
```bash
# ä½¿ç”¨Apache Benchæµ‹è¯•é›†ç¾¤æ€§èƒ½
ab -n 1000 -c 10 -H "Authorization: Bearer valid_token" \
   http://load-balancer/api/user/list
```

### 3. é«˜å¯ç”¨æµ‹è¯•
```bash
# åœæ­¢èŠ‚ç‚¹1
docker-compose stop app

# éªŒè¯èŠ‚ç‚¹2å’ŒèŠ‚ç‚¹3ä»å¯æ­£å¸¸æœåŠ¡
curl -X GET "http://node2:8081/api/user/list" \
  -H "Authorization: Bearer valid_token"
```

## ğŸ“Š ç›‘æ§ä¸è¿ç»´

### 1. å¥åº·æ£€æŸ¥
```bash
# æ£€æŸ¥åº”ç”¨å¥åº·çŠ¶æ€
curl http://node:8080/actuator/health

# æ£€æŸ¥Redisè¿æ¥
redis-cli -h redis-host ping
```

### 2. ç›‘æ§æŒ‡æ ‡
- Tokené»‘åå•å¤§å°
- Redisè¿æ¥çŠ¶æ€
- æ•°æ®åº“è¿æ¥æ± çŠ¶æ€
- åº”ç”¨å“åº”æ—¶é—´

### 3. æ—¥å¿—èšåˆ
å»ºè®®ä½¿ç”¨ELK Stackæˆ–ç±»ä¼¼æ–¹æ¡ˆæ”¶é›†å„èŠ‚ç‚¹æ—¥å¿—:
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
docker-compose logs -f app

# æŸ¥çœ‹Redisæ—¥å¿—
docker-compose logs -f redis
```

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. å®‰å…¨è€ƒè™‘
- **JWTå¯†é’¥åŒæ­¥**: æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä½¿ç”¨ç›¸åŒçš„JWTå¯†é’¥
- **Rediså®‰å…¨**: ç”Ÿäº§ç¯å¢ƒå»ºè®®å¯ç”¨Rediså¯†ç è®¤è¯
- **ç½‘ç»œå®‰å…¨**: ä½¿ç”¨VPCæˆ–é˜²ç«å¢™ä¿æŠ¤å†…éƒ¨é€šä¿¡

### 2. æ€§èƒ½ä¼˜åŒ–
- **Redisè¿æ¥æ± **: é…ç½®åˆé€‚çš„è¿æ¥æ± å¤§å°
- **Token TTL**: åˆç†è®¾ç½®Tokenè¿‡æœŸæ—¶é—´
- **ç¼“å­˜ç­–ç•¥**: æ ¹æ®ä¸šåŠ¡éœ€æ±‚è°ƒæ•´ç¼“å­˜ç­–ç•¥

### 3. æ•…éšœå¤„ç†
- **Redisæ•…éšœ**: ç³»ç»Ÿä¼šè‡ªåŠ¨é™çº§ï¼Œä½†é€€å‡ºç™»å½•åŠŸèƒ½å—å½±å“
- **æ•°æ®åº“æ•…éšœ**: å½±å“æ‰€æœ‰èŠ‚ç‚¹ï¼Œéœ€è¦å¿«é€Ÿæ¢å¤
- **èŠ‚ç‚¹æ•…éšœ**: è´Ÿè½½å‡è¡¡å™¨è‡ªåŠ¨åˆ‡æ¢åˆ°å¥åº·èŠ‚ç‚¹

## ğŸ”® æ‰©å±•å»ºè®®

### 1. è¿›ä¸€æ­¥ä¼˜åŒ–
- ä½¿ç”¨Redis Clusteræé«˜Rediså¯ç”¨æ€§
- å®ç°Tokenåˆ·æ–°æœºåˆ¶
- æ·»åŠ åˆ†å¸ƒå¼é”é˜²æ­¢å¹¶å‘é—®é¢˜

### 2. ç›‘æ§å¢å¼º
- é›†æˆPrometheus + Grafanaç›‘æ§
- æ·»åŠ è‡ªå®šä¹‰ä¸šåŠ¡æŒ‡æ ‡
- å®ç°å‘Šè­¦æœºåˆ¶

### 3. å®‰å…¨å¢å¼º
- å®ç°IPç™½åå•
- æ·»åŠ è¯·æ±‚é¢‘ç‡é™åˆ¶
- é›†æˆOAuth2/OIDC

## ğŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ”¹è¿›ï¼Œç³»ç»Ÿç°å·²å®Œå…¨æ”¯æŒåˆ†å¸ƒå¼é›†ç¾¤éƒ¨ç½²ï¼š

âœ… **å®‰å…¨æ€§**: Tokené»‘åå•åœ¨é›†ç¾¤é—´å®æ—¶åŒæ­¥  
âœ… **å¯æ‰©å±•æ€§**: æ”¯æŒæ°´å¹³æ‰©å±•ï¼ŒæŒ‰éœ€æ·»åŠ èŠ‚ç‚¹  
âœ… **é«˜å¯ç”¨æ€§**: å•èŠ‚ç‚¹æ•…éšœä¸å½±å“æ•´ä½“æœåŠ¡  
âœ… **çµæ´»æ€§**: æ”¯æŒå•æœºå’Œé›†ç¾¤ä¸¤ç§éƒ¨ç½²æ¨¡å¼  

æ‚¨ç°åœ¨å¯ä»¥æ ¹æ®ä¸šåŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„éƒ¨ç½²æ¨¡å¼ï¼Œç”Ÿäº§ç¯å¢ƒå¼ºçƒˆæ¨èä½¿ç”¨Redisæ¨¡å¼ä»¥ç¡®ä¿é›†ç¾¤å®‰å…¨æ€§ã€‚
